<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Hub Connection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonlint/1.6.0/jsonlint.min.js"></script>
    <script scr="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.0/axios.min.js"></script>
    <script>
        let all_log = "";
        let cur_address = "";
        function fetch_hub_log() {
            fetch('/hub_log', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                })
                    .then((response) => {
                        return response.json();
                    })
                    .then((data) => {
                        all_log = data.log;
                        let select_tag = document.getElementById("log_select");
                        let sel = select_tag.value;
                        let spl = all_log.split('\n');
                        // spl.forEach(lg => {
                        //         if (lg.slice(0, 6) == "Client") {
                        //             ser_log += "\n" + lg;
                        //         }
                        //     })
                        if (sel == "All") {
                            document.getElementById("log").value = data.log;
                        }
                        if (sel == "Server") {
                            ser_log = "";
                            spl.forEach(lg => {
                                if (lg.slice(0, 6) == "SERVER") {
                                    ser_log += "\n" + lg;
                                }
                            })
                            document.getElementById("log").value = ser_log;
                        }
                        if (sel == "Clients") {
                            cli_log = "";
                            spl.forEach(lg => {
                                if (lg.slice(0, 6) == "Client") {
                                    cli_log += "\n" + lg;
                                }
                            })
                            document.getElementById("log").value = cli_log;
                        }
                    })
                    .catch((error) => {
                        console.log(error);
                    })
        }
        window.onload = async function () {
            document.getElementById("send_button").onclick = function () {
                try {
                    let str_res = document.getElementById("source").value;
                    let result = jsonlint.parse(document.getElementById("source").value);
                    if (result) {
                        document.getElementById("result").innerHTML = "JSON is valid!";
                        document.getElementById("result").className = "pass";
                        if (document.getElementById("reformat").checked) {
                            document.getElementById("source").value = JSON.stringify(result, null, "  ");
                        }
                        fetch('/socket_send', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({data: str_res, address: cur_address})
                        })
                            .then((response) => {
                                return response.json();
                            })
                            .then((data) => {
                                console.log(data);
                                fetch_hub_log();
                            })
                            .catch((error) => {
                                console.log(error);
                            })

                    }
                } catch (e) {
                    document.getElementById("result").innerHTML = e;
                    document.getElementById("result").className = "fail";
                }
            };

            document.getElementById("connect_button").onclick = function () {
                document.getElementById("connect_button").disabled = true;
                fetch('/create_socket_client', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                })
                    .then((response) => {
                        return response.json();
                    })
                    .then((data) => {
                        console.log(data);
                        cur_address = data.address;
                        fetch_hub_log();
                    })
                    .catch((error) => {
                        console.log(error);
                    })
            };

            document.getElementById("reload_log").onclick = function () {
                fetch_hub_log();
            }
        }
    </script>
    <style>
        body {
            font-family: sans-serif;
        }

        #result {
            padding: 1em;
            max-width: 550px;
        }

        .pass {
            background-color: #efe;
            color: #393;
            border: 2px solid #393;
        }

        .fail {
            background-color: #fee;
            color: #933;
            border: 2px solid #933;
        }

        #send_button {
            padding: 5px 20px;
        }

        .con_discon {
            padding: 10px 0px;
        }

        .select_log {
            padding: 10px 5px;
        }
    </style>
</head>

<body>
    <div class="con_discon">
        <button id="connect_button">Connect</button>
        <!-- <button id="disconnect_button">Disconnect</button> -->
    </div>
    <textarea id="source" rows="10" cols="30"></textarea>
    <div>
        <button id="send_button">Send</button>
        <input type="checkbox" value="yes" id="reformat"><label for="reformat">reformat JSON</label>
    </div>

    <pre id="result" class="pass">JSON is valid!</pre>
    <div class="select_log">
        <select id="log_select">
            <option>All</option>
            <option>Server</option>
            <option>Clients</option>
        </select>
        <button id="reload_log">Reload</button>
    </div>
    <textarea readonly id="log" rows="20" cols="60"></textarea>
</body>
</body>

</html>